# Soft Navigation JavaScript Review

## Общее впечатление
- Скрипт `wwwroot/js/soft-navigation.js` реализует логику "мягкой" навигации с подменой содержимого `#app`, управлением анимациями и ловлей отправки форм/кликов по ссылкам.
- Код оформлен как большой самовызывающийся модуль без явного разделения на подмодули, что затрудняет сопровождение и тестирование.

## Сильные стороны
- Есть проверки на поддержку API (например, `matchMedia`, `animate`, `fetch`).
- Предусмотрена отмена текущей анимации перед запуском новой, чтобы избежать "гонок".
- Обработчики кликов/submit ограничены корневым контейнером `data-soft-root`, что снижает риск перехвата чужих элементов.
- Управление состоянием pending для `fetch` и `XMLHttpRequest` помогает синхронизировать глобальные индикаторы загрузки.

## Потенциальные узкие места
1. **Размер и связность модуля**. Файл превышает 900 строк, функции и состояния тесно связаны через замыкание. Это усложняет понимание и тестирование, не позволяет переиспользовать логику ожидания анимаций/переходов в других частях приложения.【F:wwwroot/js/soft-navigation.js†L1-L320】
2. **Отсутствие обработки ошибок контента**. При парсинге ответа мы молча редиректим на `window.location` при любой ошибке, что затрудняет диагностику. Нет логирования, поэтому понять причину провала "мягкой" навигации сложно.【F:wwwroot/js/soft-navigation.js†L480-L720】
3. **Сброс состояний кнопок**. `startButtonLoading`/`stopButtonLoading` завязаны на `WeakMap`, но ошибки при монтировании новых DOM-узлов могут оставить кнопку в состоянии загрузки (например, если переход прервётся). Нет тайм-аута или аварийного сброса.【F:wwwroot/js/soft-navigation.js†L200-L360】
4. **Hook глобального `fetch`/`XMLHttpRequest`**. Переопределение глобальных API может конфликтовать с сторонним кодом, усложнить отладку и создать двойные индикаторы загрузки при вложенных вызовах (например, если сторонние библиотеки уже оборачивают `fetch`). Нет возможности отключить поведение на отдельных запросах (кроме заголовка `X-Soft-Nav`).【F:wwwroot/js/soft-navigation.js†L760-L920】
5. **Дублирование логики анимаций**. Управление `transition` и `will-change` повторяется в нескольких местах; нет централизованного менеджера анимаций или fallback'ов для браузеров без `animate`. Это повышает риск ошибок при добавлении новых переходов.【F:wwwroot/js/soft-navigation.js†L20-L180】
6. **Сохранение и восстановление scroll-позиции**. Комментарий к `window.scrollTo` отключён, из-за чего пользователи могут оставаться на середине страницы после навигации. Нет альтернативного решения (например, сохранения `scrollRestoration`).【F:wwwroot/js/soft-navigation.js†L560-L640】

## Рекомендации по улучшению
1. **Рефакторинг на модули**: разбить код на логические блоки (`animations.js`, `transitions.js`, `navigation.js`, `loading-indicators.js`). Использовать ES-модули или bundler (например, Vite/Webpack) для сборки. Это упростит сопровождение и тестирование юнитов.
2. **Логирование и наблюдаемость**: добавить `console.debug`/`console.error` с флагом включения через `data-soft-debug`, чтобы легче диагностировать причины fallback на full reload, ошибки парсинга и проблемные переходы.
3. **Управление состоянием загрузки кнопок**: добавить безопасный сброс в `finally` блока `handleNavigation`, а также внешнюю функцию для принудительного сброса (например, при `popstate`). Рассмотреть кастомное событие `soft:loading-state` для интеграции со спиннерами.
4. **Безопасные хуки сетевых API**: вместо перезаписи `fetch`/`XMLHttpRequest` внедрить обёртку, которую использует только собственный код, или по крайней мере сохранять и возвращать оригинал через `Symbol.for('soft-nav:fetch')`, чтобы сторонний код мог их восстановить. Добавить детект повторной инициализации, чтобы не навешивать события повторно.
5. **Анимации и `prefers-reduced-motion`**: расширить поддержку accessibility (например, вручную устанавливать конечные состояния без анимаций, синхронизировать с `prefers-reduced-motion` изменениями через `matchMedia().addEventListener('change', ...)`).
6. **Управление скроллом**: реализовать сохранение/восстановление позиции (например, `history.scrollRestoration = 'manual'`) и обеспечить прокрутку к началу или к `data-soft-scroll-target` после успешного перехода.
7. **Тесты**: добавить unit/интеграционные тесты через Jest + jsdom для ключевых функций (`waitForTransition`, `buildGetUrl`, `shouldHandleLink`). Это позволит защищать от регрессий при рефакторинге.
8. **Документация API**: описать доступные `data-` атрибуты (`data-soft-transition`, `data-soft-ignore`, `data-soft-root`) и ожидания от верстки, чтобы фронтенд-разработчики корректно интегрировали новые страницы.

## Быстрые выигрыши
- Включить `passive: true` для `popstate` не требуется, но для глобального `scroll` (если будет использован) стоит учитывать.
- Добавить защиту от повторной инициализации (проверять флаг на `window.__softNavInitialized`).
- Проверить, что `history.replaceState` вызывается только один раз, иначе при повторной инициализации стек истории может задвоиться.


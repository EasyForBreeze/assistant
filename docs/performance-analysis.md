# Анализ потенциальных узких мест производительности

## Поиск клиентов по всем реалмам
В `Pages/Clients/Search.cshtml.cs` каждая загрузка страницы поиска проходит по всему списку реалмов и для каждого из них вызывает `ClientsService.SearchClientsAsync`. Все запросы выполняются последовательно, поэтому общее время ответа растёт линейно с числом реалмов: при десятках реалмов пользователь получает десятки последовательных HTTP-вызовов к Keycloak, хотя большинство из них возвращает пустой результат.【F:Pages/Clients/Search.cshtml.cs†L24-L41】

**Оптимизация:** запускать поисковые запросы параллельно (через `Task.WhenAll`) либо накладывать раннюю фильтрацию по выбранному реалму. Также можно кешировать результаты поиска для популярных запросов и сокращать число вызовов `SearchClientsAsync`.

## Поиск ролей по множеству клиентов
Метод `FindRolesAcrossClientsAsync` перебирает порцию клиентов и для каждого делает отдельный HTTP-вызов `GetClientRolesAsync`, который в свою очередь обращается к Keycloak. Все вызовы выполняются последовательно, поэтому сканирование 25 клиентов с лимитом 10 ролей уже порождает 25 отдельных сетевых запросов; увеличение лимитов приводит к лавинообразному росту времени выполнения.【F:KeyCloak/ClientsService.cs†L474-L520】

**Оптимизация:** распараллелить обращения к Keycloak или добавить кэширование ролей по клиентам. Ещё один вариант — уменьшить количество сетевых вызовов, объединив несколько клиентов в один batched-запрос на стороне сервиса (если API это поддерживает).

## Массовое назначение/снятие сервисных ролей
При назначении ролей (`AssignServiceRolesToServiceAccountAsync`) код сначала для каждого `ClientId` вызывает `GetClientShortByClientIdAsync`, что приводит к отдельному HTTP-запросу per client. Затем для каждой роли выполняется отдельный запрос `GET clients/{id}/roles/{role}` перед отправкой `POST`/`DELETE`. В сумме операция назначение/снятия ролей выполняет `O(N)` дополнительных сетевых запросов при `N` парах клиент–роль.【F:KeyCloak/ClientsService.cs†L707-L820】

**Оптимизация:** кешировать результаты поиска клиента и его ролей в пределах одной операции, а также загружать сразу весь список ролей клиента (одним запросом) и искать их локально. Это уменьшит количество обращений к Keycloak с линейного по числу ролей до постоянного.

## Загрузка деталей клиента
`GetClientDetailsAsync` для каждой карточки клиента всегда запрашивает до 1000 локальных ролей (`GetClientRolesAsync`) и, при наличии сервисного аккаунта, ещё и полную карту назначений через `GetServiceAccountRolesAsync`. Эти обращения выполняются последовательно и даже при малом объёме данных добавляют два сетевых RTT на каждый просмотр карточки. При клиентах с большим числом ролей 1000-предельный запрос загружает и десериализует излишне большие ответы.【F:KeyCloak/ClientsService.cs†L327-L359】

**Оптимизация:** уменьшить лимит (`max`) до фактически отображаемого количества, догружая остальные роли по требованию, и запускать загрузку локальных и сервисных ролей параллельно. Дополнительно можно кешировать роли между повторными открытиями карточки в течение короткого времени.

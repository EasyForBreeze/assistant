@model Assistant.Pages.ClientsPageModel

@{
    var currentPage = (ViewContext.RouteData.Values["page"] as string) ?? string.Empty;
    var returnUrl = string.IsNullOrEmpty(currentPage)
        ? null
        : Url.Page(currentPage, new { q = Model.Q, pageNumber = Model.PageNumber });
}

@if (!Model.Clients.Any() && Model.ShowEmptyMessage)
{
    <div class="kc-card p-10 text-center">
        <div class="text-slate-200 text-lg font-semibold mb-1">Нет клиентов</div>
        <div class="text-slate-400 text-sm">Попробуйте другой поиск или создайте нового клиента.</div>
    </div>
}
else if (Model.Clients.Any())
{
    <!-- Сетка карточек клиентов -->
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        @foreach (var c in Model.Clients)
        {
            // один раз материализуем, чтобы не итерировать несколько раз
            var envList = Model.Envs(c.Realm).ToList();
            var displayName = c.DisplayName;
            var subtitle = string.Equals(displayName, c.ClientId, StringComparison.OrdinalIgnoreCase)
                ? $"Realm: {c.Realm}"
                : displayName;
            var initialSource = string.IsNullOrWhiteSpace(displayName)
                ? c.ClientId
                : displayName;
            var clientInitial = string.IsNullOrWhiteSpace(initialSource)
                ? "?"
                : char.ToUpperInvariant(initialSource.Trim()[0]).ToString();
            var hasEnvironments = envList.Any();

            <a asp-page="/Clients/Details" asp-route-realm="@c.Realm" asp-route-clientId="@c.ClientId"
               asp-route-returnUrl="@returnUrl"
               class="block group client-card"
               data-search="@($"{c.ClientId} {c.Realm} {displayName}")">
                <div class="kc-card kc-card--hover client-card__surface p-5 min-h-[210px] overflow-hidden transition relative">
                    <span class="client-card__glare" aria-hidden="true"></span>

                    <!-- Контур-линия окружений (внизу карточки) -->
                    @if (hasEnvironments)
                    {
                        <div class="absolute inset-x-0 top-0 h-[4px] flex overflow-hidden">
                            @foreach (var e in envList)
                            {
                                <span class="flex-1 h-full bg-gradient-to-r @Model.EnvBarGradient(e)"></span>
                            }
                        </div>
                    }

                    <div class="relative h-full flex flex-col">
                        <!-- Заголовок + статус -->
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex items-start gap-3 min-w-0">
                                <div class="client-card__avatar" aria-hidden="true">@clientInitial</div>
                                <div class="min-w-0">
                                    <div class="text-slate-100 font-semibold text-lg truncate">@c.ClientId</div>
                                    <div class="client-card__realm">@c.Realm</div>
                                </div>
                            </div>
                            <span class="client-card__status @(c.Enabled ? "client-card__status--enabled" : "client-card__status--disabled")">
                                @(c.Enabled ? "Enabled" : "Disabled")
                            </span>
                        </div>

                        <!-- Описание -->
                        <div class="client-card__subtitle mt-3 line-clamp-2">
                            @subtitle
                        </div>

                        <!-- Окружения (чипы) -->
                        <div class="mt-auto">
                            <div class="client-card__divider mt-5 mb-3"></div>
                            @if (hasEnvironments)
                            {
                                <div class="client-card__envs-label">Окружения</div>
                                <div class="mt-2 flex items-center gap-2 flex-wrap">
                                    @foreach (var e in envList)
                                    {
                                        <span class="kc-chip client-card__chip">@e</span>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="client-card__empty">Нет окружений</div>
                            }
                        </div>
                    </div>
                </div>
            </a>
        }
    </div>

    @if (Model.TotalPages > 1)
    {
        <div class="flex justify-center mt-6">
            <nav class="flex items-center gap-2">
                @if (Model.HasPreviousPage)
                {
                    <form method="get" asp-page="@currentPage" class="inline-flex" data-soft-transition="#clientsResults">
                        <input type="hidden" name="q" value="@Model.Q" />
                        <input type="hidden" name="pageNumber" value="@(Model.PageNumber - 1)" />
                        <button type="submit" class="btn-subtle">Предыдущая</button>
                    </form>
                }
                <span class="text-sm text-slate-400">Страница @Model.PageNumber of @Model.TotalPages</span>
                @if (Model.HasNextPage)
                {
                    <form method="get" asp-page="@currentPage" class="inline-flex" data-soft-transition="#clientsResults">
                        <input type="hidden" name="q" value="@Model.Q" />
                        <input type="hidden" name="pageNumber" value="@(Model.PageNumber + 1)" />
                        <button type="submit" class="btn-subtle">Следующая</button>
                    </form>
                }
            </nav>
        </div>
    }
}
